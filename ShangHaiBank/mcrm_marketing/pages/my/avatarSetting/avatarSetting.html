<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>头像设置</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script src="../../common/AppBooter.js"></script>
		<script src="avatarSetting.js"></script>
		<script src="exif.js"></script>
		<script src="photoSql.js"></script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">头像设置</h1>
		</header>
		<div class="mui-content">
			<div class="mui-scroll-wrapper mui-nofootscroll">
				<div class="mui-scroll">
					<div class="userPicSet">
						<img id="imgss">
						<img id="imgs" style="display: none;">
					</div>
					<div id="userpsBt1" class="userpsBt">
						<button class="mui-btn" onclick="appendByCamera()">拍照</button>
						<button class="mui-btn" onclick="appendByGallery()">从相册选取</button>
					</div>
					<div id="userpsBt2" class="userpsBt" style="display: none;">
						<button class="mui-btn" onclick="appendByCameras()">放弃</button>
						<button class="mui-btn" onclick="appendByGallerys()">上传</button>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script>
		mui.init({
			swipeBack: false
		});
		mui('.mui-scroll-wrapper').scroll();
		var imgs = document.getElementById('imgs');
		var imgss = document.getElementById('imgss');
		//创建数据库
		OpenDB();
		createPhotoTable();
//		var avaUpload = document.getElementById('avaUpload');
		//判断安卓是否需要旋转
		var avapath;
		//上传文件
		var files = [];
		var server = basePath + "FileUpload";
		var target = "";
		mui.plusReady(function() {
//			var wst = plus.nativeUI.showWaiting();
			if (plus.storage.getItem("_userPic") == ""||plus.storage.getItem("_userPic") == null) {
				//如果头像未设置过，则为其默认一个头像
				var path = '../homePage/tou1.png';
				imgss.src = path;
//				wst.close();
			} else {
				//现获取本地头像
				var filesName = plus.storage.getItem("_userPic");
				var uploadName = plus.storage.getItem("_userPic");
				var paths = "file://" + plus.io.convertLocalFileSystemURL("_doc/" + filesName);
				plus.io.resolveLocalFileSystemURL(paths, function() {
					//获取缓存成功 
					imgss.src = paths;
//					wst.close();
				}, function() {
					//获取不到文件，重新缓存
					var saveLocalFile = "_doc/" + filesName;
					var durls = basePath + "AnnexeDownload?filename=" + uploadName + "&annexeName=" + filesName;
					var options = {
						method: "GET",
						filename: saveLocalFile
					};
					var dtask = plus.downloader.createDownload(durls, options, function(d, status) {
						// 下载完成
						if (status == 200) {
							var patht = plus.io.convertLocalFileSystemURL(d.filename);
							patht = "file://" + patht;
							console.log('下载成功' + d.filename);
							imgss.src = patht;
//							wst.close();
						} else {
							mui.alert("下载失败!");
//							wst.close();
						}
					});
					//dtask.addEventListener( "statechanged", onStateChanged, false );
					dtask.start();
				});
			}
		});
	</script>

</html>