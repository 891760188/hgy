<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title>摇一摇</title>
		<script src="../../common/AppBooter.js"></script>
		<script type="text/javascript" src="../../../resource/shake/js/common.js" ></script>
		<link rel="stylesheet" href="../../../resource/shake/css/common.css" type="text/css" charset="utf-8"/>
		<script type="text/javascript">
		
		</script>		
		
	</head>
	<body>
		<div class="mui-content shakeContainer">
			<div id="up"></div>
			<div id="down"></div>
		</div>
		<div id="popover1" class="mui-popover mui-title-menu">
	    	<div class="mui-popover-arrow"></div>
			<ul class="mui-table-view">
				<li id="allCust" class="mui-table-view-cell"><a href="1">1公里</a></li>
				<li class="mui-table-view-cell"><a href="3">3公里</a></li>
				<li class="mui-table-view-cell"><a href="10">10公里</a></li>
			</ul>
		</div>
	</body>
	<script>
		var condition;//查询条件
		var lon;//定位经度
		var lat;//定位纬度
		var href = 3;//搜索范围
		var custLon;//客户经度
		var custLat;//客户纬度
		var p=null;
		var iLast=2,MAX=20;
		var up=null,down=null,offset=50;
		var t=null;
		var webview_style0 = {
			popGesture: "close"
		};
		// H5 plus事件处理
		function plusReady(){
			// 锁定只能竖屏显示
			plus.screen.lockOrientation( "portrait-primary" );
			// 监听加速度
			plus.accelerometer.watchAcceleration( function ( a ) {
				if(!up){
					return;
				}
				if ( !p && ( Math.abs(a.xAxis)+Math.abs(a.yAxis)+Math.abs(a.zAxis) > MAX ) ){
					// Play audio
					p = plus.audio.createPlayer("_www/audio/shake.wav");
					p.play();
					setTimeout( function(){
						// Change background image
						var index = Math.round(Math.random()*3+1);
						if ( iLast == index ) {
							index++;
							if ( index > 4 ) {
								index = 1;
							}
						}
						//document.body.style.backgroundImage="url(../../../images/shake/"+index+".jpg)";
						iLast = index;
						// Stop play audio
						p.stop();
						delete p;
						p = null;
						var random=parseInt(Math.random()*100,10);
						var wt = plus.nativeUI.showWaiting();
						plus.geolocation.getCurrentPosition(function(p) {
							if (!p.addresses) {
								wt.close();
								mui.alert('定位失败，请检查相关设备!', '提示');
							} else {
								condition = {
									lon: p.coords.longitude,
									lat: p.coords.latitude,
									custType: "",
									distance: href,
									searchContent : ""
								};
								lon = p.coords.longitude;
								lat = p.coords.latitude;
								_App.ajax({
									type: "get",
									url: basePath + 'mobileNearCustAction!selectDistance.json?conditions=' + JSON.stringify(condition),
									cache: false,
									dataType: "json",
									success: function(response) {
										var data = response.json.data;
										if(data.length > 1){
											var i = randomNumBoth(0,data.length-1);
											custLon = data[i].LONGITUDE;
											custLat = data[i].LATITUDE;
										}else if(data.length == 1){
											custLon = data[0].LONGITUDE;
											custLat = data[0].LATITUDE;
										}
										mui.openWindow({
											id: 'customer-detail.html',
											url: '../../custManage/comCustView.html',
											styles: webview_style0,
											extras:{
										        lon : lon,
										        lat : lat,
										        custLon : custLon,
										        custLat : custLat
										    },
											show: {
												aniShow: 'slide-in-right'
											},
											waiting: {
												autoShow: false
											}
										});
										wt.close();
									}
								});
							}
						}, function(e) {
							wt.close();
							mui.alert("Geolocation error: " + e.message);
						}
//						, {
//							provider: 'baidu'
//						}
						);
//						var detailPage=plus.webview.create("customer-detail.html");
//						var ws=plus.nativeUI.showWaiting();
//						setTimeout(function(){
//							ws.close();
//							detailPage.show();
//						},1000)
					}, 2000 );
					// Animation
					offset=up.offsetHeight/2;
					up.style.webkitTransform = "translateY(-"+offset+"px)";
					up.style.msTransform = "translateY(-"+offset+"px)";
					down.style.webkitTransform = "translateY("+offset+"px)";
					down.style.msTransform = "translateY("+offset+"px)";
					if ( t ) {
						clearTimeout( t );
					}
					t = setTimeout( function() {
						t = null;
						up.style.webkitTransform = "";
						up.style.msTransform = "";
						down.style.webkitTransform = "";
						down.style.msTransform = "";
					}, 700 );
				}
			}, function ( e ) {
				//outSet( "Watch failed: "+e.message );
			}, {frequency:100} );
		}
		
		//
		function randomNumBoth(min,max){
			var range = max - min;
			var rand  = Math.random();
			var num = min + Math.round(rand * range);
			return num;
		}
		
		if(window.plus){
			plusReady();
		}else{
			document.addEventListener("plusready",plusReady,false);
		}
		// 监听DOMContentLoaded事件
		document.addEventListener("DOMContentLoaded",function(){
			up=document.getElementById("up");
			down=document.getElementById("down");
			offset=up.offsetHeight/2;
		},false);
		// 解锁并关闭
		var _back=window.back;
		function unlockback(){
			plus.screen.unlockOrientation();
			_back();
		}
		window.back=unlockback;
		
		//标签菜单
		function showTitleMenu(){	
			mui('#popover1').popover('toggle');
		};
		mui('.mui-table-view').on('tap','li.mui-table-view-cell',function(){
			showTitleMenu();
		});
		
		/*客户筛选 UI逻辑  end*/
		mui('#popover1').on('tap','a',function(){
			href = this.getAttribute('href');
			mui.toast("摇" + href+"公里以内的客户");
		});
	</script>
</html>