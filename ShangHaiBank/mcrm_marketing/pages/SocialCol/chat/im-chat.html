<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>聊天窗口</title>
		<script type="text/javascript" src="../../common/AppBooter.js"></script>
		<script type="text/javascript" src="../../../../frame/MK-App-Scroll-Patch.js"></script>
		<link href="mui.imageviewer.css" rel="stylesheet" />
		<script src="mui.imageViewer.js"></script>
		<script src="arttmpl.js"></script>
		<script src="im-chat.js"></script>
		<style>
			html,
			body {
				height: 100%;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
			}
			
			footer {
				position: fixed;
				width: 100%;
				height: 50px;
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				overflow: hidden;
				padding: 0px 50px;
				background-color: #fafafa;
			}
			
			.footer-left {
				position: absolute;
				width: 50px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 4px;
			}
			
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			
			.footer-center {
				height: 100%;
				padding: 5px 0px;
			}
			
			.footer-center [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			
			.footer-center .input-text {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				line-height: 18px !important;
				font-family: verdana !important;
				overflow: hidden;
			}
			
			.footer-center .input-sound {
				background-color: #eee;
			}
			
			.mui-content {
				height: 100%;
				padding: 44px 0px 50px 0px;
				overflow: auto;
				background-color: #eaeaea;
			}
			
			#msg-list {
				height: 100%;
				overflow: auto;
				-webkit-overflow-scrolling: touch;
			}
			
			.msg-item {
				padding: 8px;
				clear: both;
			}
			
			.msg-item .mui-item-clear {
				clear: both;
			}
			
			.msg-item .msg-user {
				width: 38px;
				height: 38px;
				border: solid 1px #d3d3d3;
				display: inline-block;
				background: #fff;
				border-radius: 3px;
				vertical-align: middle;
				text-align: center;
				float: left;
				color: #ddd;
				line-height: 38px;
				overflow: hidden;
			}
			
			.msg-item .msg-user:before {
				font-size: 25px;
			}
			
			.msg-item .msg-user-img {
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				color: #ddd;
				background-color: #fff;
			}
			
			.msg-item .msg-content {
				display: inline-block;
				border-radius: 5px;
				border: solid 1px #d3d3d3;
				background-color: #FFFFFF;
				color: #333;
				padding: 8px;
				vertical-align: top;
				font-size: 15px;
				position: relative;
				margin: 0px 8px;
				max-width: 75%;
				min-width: 35px;
				float: left;
			}
			
			.msg-item .msg-content .msg-content-inner {
				overflow-x: hidden;
			}
			
			.msg-item .msg-content .msg-content-arrow {
				position: absolute;
				border: solid 1px #d3d3d3;
				border-right: none;
				border-top: none;
				background-color: #FFFFFF;
				width: 10px;
				height: 10px;
				left: -5px;
				top: 12px;
				-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);
			}
			
			.msg-item-self .msg-user,
			.msg-item-self .msg-content {
				float: right;
			}
			
			.mui-bar-nav~.mui-content .mui-pull-top-pocket {
				top: 0;
			}
			
			.msg-item-self .msg-content .msg-content-arrow {
				left: auto;
				right: -5px;
				-webkit-transform: rotateZ(225deg);
				transform: rotateZ(225deg);
			}
			
			.msg-item-self .msg-content,
			.msg-item-self .msg-content .msg-content-arrow {
				background-color: #4CD964;
				color: #fff;
				border-color: #2AC845;
			}
			
			footer .mui-icon {
				color: #000;
			}
			
			footer .mui-icon:active {
				color: #007AFF !important;
			}
			
			footer .mui-icon-paperplane:before {
				content: "发送";
			}
			
			footer .mui-icon-paperplane {
				/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}
			
			#msg-sound {
				-webkit-user-select: none !important;
				user-select: none !important;
			}
			
			.rprogress {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 140px;
				height: 140px;
				margin-left: -70px;
				margin-top: -70px;
				background-image: url(../images/arecord.png);
				background-repeat: no-repeat;
				background-position: center center;
				background-size: 30px 30px;
				background-color: rgba(0, 0, 0, 0.7);
				border-radius: 5px;
				display: none;
			}
			
			.rschedule {
				background-color: rgba(0, 0, 0, 0);
				border: 5px solid rgba(0, 183, 229, 0.9);
				opacity: .9;
				border-left: 5px solid rgba(0, 0, 0, 0);
				border-right: 5px solid rgba(0, 0, 0, 0);
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			
			.rsalert {
				font-size: 12px;
				color: #bbb;
				text-align: center;
				position: absolute;
				border-radius: 5px;
				width: 130px;
				margin: 5px 5px;
				padding: 5px;
				left: 0px;
				bottom: 0px;
			}
			
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			
			#h {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				font-family: verdana !important;
				line-height: 18px !important;
				overflow: visible;
				position: absolute;
				left: -1000px;
				right: 0px;
				word-break: break-all;
				word-wrap: break-word;
			}
			
			.cancel {
				background-color: darkred;
			}
		</style>
	</head>

	<body contextmenu="return false;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" id="muiTitleId"></h1>
			<a class="mui-icon icon-users mui-pull-right" href="javascript:go2ManagerGroups();"></a>

		</header>
		<pre id='h'></pre>
		<script id='msg-template' type="text/template">
			<% for(var i in record){ var item=record[i]; %>
				<div class="msg-item <%= (item.sender=='self'?' msg-item-self':'') %>" msg-type='<%=(item.type)%>' msg-content='<%=(item.content)%>'>
					<% if(item.sender=='self') { %>
						<i class="msg-user mui-icon icon-user"></i>
						<% } else { %>
							<img class="msg-user-img" src="../../images/logo-mui.png" alt="" />
							<% } %>

								<div class="msg-content">
									<div class="msg-content-inner">
										<% if(item.type=='text' ) { %>
											<%= (item.content|| '&nbsp;&nbsp;') %>
												<% } else if(item.type=='image' ) { %>
													<img class="msg-content-image" src="<%=(item.content)%>" style="max-width: 100px;" />
													<% } else if(item.type=='sound' ) { %>
														<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
														<span class="play-state">点击播放</span>
														<% } else if(item.type=='share' ) {
															var cons=(item.content).split("==s=s==");
															%>
															<div class="ys-cfiCon" id="<%=(cons[0])%>">
																<div class="ys-cfiQue"><%=(cons[1])%></div>
																<div class="ys-cfiAbu"><span><%=(cons[2])%></span></div>
																<div class="ys-cfiAns"><b>今日计划:</b><span><%=(cons[3])%></span></div>
																<ul class="mui-table-view">
																	<li class="mui-table-view-cell">
																		<a class="mui-navigate-right">
																			查看详情
																		</a>
																	</li>
																</ul>
															</div>
														<% } %>
									</div>
									<div class="msg-content-arrow"></div>
								</div>
								<div class="mui-item-clear"></div>
				</div>
				<% } %>
		</script>
		<div class="mui-content">
			<div id="pullrefresh" class="mui-scroll-wrapper mui-fullscroll">
				<div class="mui-scroll">
					<div id='msg-list'>
					</div>
				</div>
			</div>
		</div>
		<footer>
			<div class="footer-left">
				<i id='msg-image' class="mui-icon mui-icon-camera" style="font-size: 28px;"></i>
			</div>
			<div class="footer-center">
				<textarea id='msg-text' type="text" class='input-text'></textarea>
				<button id='msg-sound' type="button" class='input-sound' style="display: none;">按住说话</button>
			</div>
			<label for="" class="footer-right">
				<i id='msg-type' class="mui-icon mui-icon-mic"></i>
			</label>
		</footer>
		<div id='sound-alert' class="rprogress">
			<div class="rschedule"></div>
			<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
		</div>
		<script type="text/javascript" charset="utf-8">
						(function($, doc) {
							$.init({
								gestureConfig: {
									tap: true, //默认为true
									doubletap: true, //默认为false
									longtap: true, //默认为false
									swipe: true, //默认为true
									drag: true, //默认为true
									hold: true, //默认为false，不监听
									release: true //默认为false，不监听
								},
								pullRefresh: {
									container: '#pullrefresh',
									down: {
										contentrefresh: '加载更多...',
										callback: pulldownRefresh
									},
									up: false
								}
							});
							template.config('escape',false);
							//---------------------------------------------------------------
							
							/**
							 * 下拉刷新具体业务实现
							 */
			//				var num = 0;
							function pulldownRefresh() {
								setTimeout(function() {
									getServerDatas();//获取初始化数据
			//						for(var i = 0; i < 10; i++) {
			//							
			//							record.unshift({
			//									sender: 'zs',
			//									type: 'text',
			//									content: '聊天内容'+num++
			//								});
			//						}
			//						bindMsgList();
									mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
								}, 1500);
							}
							/**
							 * 上拉加载具体业务实现
							 */
							function pullupRefresh() {
								setTimeout(function() {
									
									mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
								}, 1500);
							}
							//---------------------------------------------------------------
							sc_ = mui('.mui-scroll-wrapper').scroll();
							mui('#msg-list').on('tap','.ys-cfiCon',function(){
								var ids=this.getAttribute('id');
								
								if(undefined != ids && "" != ids){
									if(this.children[0].innerHTML=="分享日志"){
										var currWebId = plus.webview.currentWebview().id;
									 	_App.util.goPage('../../work/myLog/logDetail.html?id='+ids+'&pageId='+currWebId, 
									                 {refresh:true,pageId:'work_logDetail_html'});
									}
								}
							});
							//$.plusReady=function(fn){fn();};
							$.plusReady(function() {
								//必须获取进到聊天组的时间，作为历史数据的临界点
								onLinetime_ = getNowFormatDate();
								backPage = plus.webview.getWebviewById("marketingCircleId");
								/*
								 * 需初始化的信息
								 */
								/*
								 * 替换聊天室名称
								 */
								document.getElementById("muiTitleId").innerHTML = chatRoomName;
								loginName = plus.storage.getItem("userName");
								
								
								plus.webview.currentWebview().setStyle({
									softinputMode: "adjustResize"
								});
								var showKeyboard = function() {
									if ($.os.ios) {
										var webView = plus.webview.currentWebview().nativeInstanceObject();
										webView.plusCallMethod({
											"setKeyboardDisplayRequiresUserAction": false
										});
									} else {
										var Context = plus.android.importClass("android.content.Context");
										var InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
										var main = plus.android.runtimeMainActivity();
										var imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
										imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
										//var view = ((ViewGroup)main.findViewById(android.R.id.content)).getChildAt(0);
										imm.showSoftInput(main.getWindow().getDecorView(),InputMethodManager.SHOW_IMPLICIT); 
										//alert("ll");
									}
								};
			//					var record = [{
			//						sender: 'zs',
			//						type: 'text',
			//						content: 'Hi，我是 MUI 小管家！'
			//					}];
								
								var ui = {
									body: doc.querySelector('body'),
									footer: doc.querySelector('footer'),
									footerRight: doc.querySelector('.footer-right'),
									footerLeft: doc.querySelector('.footer-left'),
									btnMsgType: doc.querySelector('#msg-type'),
									boxMsgText: doc.querySelector('#msg-text'),
									boxMsgSound: doc.querySelector('#msg-sound'),
									btnMsgImage: doc.querySelector('#msg-image'),
									areaMsgList: doc.querySelector('#msg-list'),
									boxSoundAlert: doc.querySelector('#sound-alert'),
									h: doc.querySelector('#h'),
									content: doc.querySelector('.mui-content')
								};
								ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
								//alert(ui.boxMsgText.offsetWidth );
								var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;
								var msgItemTap = function(msgItem, event) {
									var msgType = msgItem.getAttribute('msg-type');
									var msgContent = msgItem.getAttribute('msg-content')
									if (msgType == 'sound') {
										player = plus.audio.createPlayer(msgContent);
										var playState = msgItem.querySelector('.play-state');
										playState.innerText = '正在播放...';
										player.play(function() {
											playState.innerText = '点击播放';
										}, function(e) {
											playState.innerText = '点击播放';
										});
									}
								};
								var imageViewer = new $.ImageViewer('.msg-content-image', {
									dbl: false
								});
								bindMsgList = function() {
									//绑定数据:
									/*tp.bind({
										template: 'msg-template',
										element: 'msg-list',
										model: record
									});*/
									ui.areaMsgList.innerHTML = template('msg-template', {
										"record": record
									});
									var msgItems = ui.areaMsgList.querySelectorAll('.msg-item');
									[].forEach.call(msgItems, function(item, index) {
										item.addEventListener('tap', function(event) {
											msgItemTap(item, event);
										}, false);
									});
									imageViewer.findAllImage();
									ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
								};
								bindMsgList();
								getServerDatas();
								window.addEventListener('resize', function() {
									ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
								}, false);
								/**
								 * 发送消息
								 * @param {Object} msg
								 */
								var send = function(msg) {
									/**
									 * 根据类型判断 
									 * 如果不是text类型，需要上传文件
									 */
									record.push(msg);
									if(msg.type != "text"){
										//如果是图片，先压缩后上传
										compressImage(msg);
									}else{
//										webSocket.send('{"chatRoomId":"'+chatRoomId+'", "fromName":"'+loginName+'","sendType":"'+msg.type+'", "content":"'+msg.content+'"}');
									}
										
									bindMsgList();
								
								};
								
								var toRobot = function(info) {
									var apiUrl = 'http://www.tuling123.com/openapi/api';
									$.getJSON(apiUrl, {
										"key": 'acfbca724ea1b5db96d2eef88ce677dc',
										"info": info,
										"userid": plus.device.uuid
									}, function(data) {
										//alert(JSON.stringify(data));
										record.push({
											sender: 'zs',
											type: 'text',
											content: data.text
										});
										bindMsgList();
									});
								};
								
								function msgTextFocus () {
									ui.boxMsgText.focus();
									setTimeout(function() {
										ui.boxMsgText.focus();
									}, 150);
								}
								
								
								//解决长按“发送”按钮，导致键盘关闭的问题；
								ui.footerRight.addEventListener('touchstart', function(event) {
									if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
										msgTextFocus();
										event.preventDefault();
									}
								});
								//解决长按“发送”按钮，导致键盘关闭的问题；
								ui.footerRight.addEventListener('touchmove', function(event) {
									if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
										msgTextFocus();
										event.preventDefault();
									}
								});
			//					ui.footerRight.addEventListener('touchcancel', function(event) {
			//						if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
			//							msgTextFocus();
			//							event.preventDefault();
			//						}
			//					});
			//					ui.footerRight.addEventListener('touchend', function(event) {
			//						if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
			//							msgTextFocus();
			//							event.preventDefault();
			//						}
			//					});
								
								ui.footerRight.addEventListener('release', function(event) {
									if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
										//showKeyboard();
										ui.boxMsgText.focus();
										setTimeout(function() {
											ui.boxMsgText.focus();
										}, 150);
			//							event.detail.gesture.preventDefault();
										send({
											sender: 'self',
											type: 'text',
											content: ui.boxMsgText.value.replace(new RegExp('\n','gm'),'<br/>')
										});
										ui.boxMsgText.value = '';
										$.trigger(ui.boxMsgText, 'input', null);
									} else if (ui.btnMsgType.classList.contains('mui-icon-mic')) {
										ui.btnMsgType.classList.add('mui-icon-compose');
										ui.btnMsgType.classList.remove('mui-icon-mic');
										ui.boxMsgText.style.display = 'none';
										ui.boxMsgSound.style.display = 'block';
										ui.boxMsgText.blur();
										document.body.focus();
									} else if (ui.btnMsgType.classList.contains('mui-icon-compose')) {
										ui.btnMsgType.classList.add('mui-icon-mic');
										ui.btnMsgType.classList.remove('mui-icon-compose');
										ui.boxMsgSound.style.display = 'none';
										ui.boxMsgText.style.display = 'block';
										//--
										//showKeyboard();
										ui.boxMsgText.focus();
										setTimeout(function() {
											ui.boxMsgText.focus();
										}, 150);
									}
								}, false);
								ui.footerLeft.addEventListener('tap', function(event) {
									var btnArray = [{
										title: "拍照"
									}, {
										title: "从相册选择"
									}];
									plus.nativeUI.actionSheet({
										title: "选择照片",
										cancel: "取消",
										buttons: btnArray
									}, function(e) {
										var index = e.index;
										switch (index) {
											case 0:
												break;
											case 1:
												var cmr = plus.camera.getCamera();
												cmr.captureImage(function(path) {
													send({
														sender: 'self',
														type: 'image',
														content: "file://" + plus.io.convertLocalFileSystemURL(path)
													});
												}, function(err) {});
												break;
											case 2:
												plus.gallery.pick(function(path) {
													send({
														sender: 'self',
														type: 'image',
														content: path
													});
												}, function(err) {}, null);
												break;
										}
									});
								}, false);
								var recordCancel = false;
								var recorder = null;
								var audio_tips = document.getElementById("audio_tips");
								ui.boxMsgSound.addEventListener('hold', function(event) {
									recordCancel = false;
									ui.boxSoundAlert.style.display = 'block';
									recorder = plus.audio.getRecorder();
									if (recorder == null) {
										plus.nativeUI.toast("不能获取录音对象");
										return;
									}
									recorder.record({
										filename: "_doc/audio/"
									}, function(path) {
										if (recordCancel) return;
										send({
											sender: 'self',
											type: 'sound',
											content: path
										});
									}, function(e) {
										plus.nativeUI.toast("录音时出现异常: " + e.message);
									});
								}, false);
								ui.body.addEventListener('drag', function(event) {
									//console.log('drag');
									if (Math.abs(event.detail.deltaY) > 50) {
										if (!recordCancel) {
											recordCancel = true;
											if (!audio_tips.classList.contains("cancel")) {
												audio_tips.classList.add("cancel");
											}
											audio_tips.innerHTML = "松开手指，取消发送";
										}
									} else {
										if (recordCancel) {
											recordCancel = false;
											if (audio_tips.classList.contains("cancel")) {
												audio_tips.classList.remove("cancel");
											}
											audio_tips.innerHTML = "手指上划，取消发送";
										}
									}
								}, false);
								ui.boxMsgSound.addEventListener('release', function(event) {
									//console.log('release');
									if (audio_tips.classList.contains("cancel")) {
										audio_tips.classList.remove("cancel");
										audio_tips.innerHTML = "手指上划，取消发送";
									}
									ui.boxSoundAlert.style.display = 'none';
									recorder.stop();
								}, false);
								ui.boxMsgSound.addEventListener("touchstart", function(e) {
									//console.log("start....");
									e.preventDefault();
								});
								ui.boxMsgText.addEventListener('input', function(event) {
									ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'remove' : 'add']('mui-icon-paperplane');
									ui.btnMsgType.setAttribute("for", ui.boxMsgText.value == '' ? '' : 'msg-text');
									ui.h.innerText = ui.boxMsgText.value.replace(new RegExp('\n','gm'),'\n-') || '-';
									ui.footer.style.height = (ui.h.offsetHeight + footerPadding) + 'px';
									ui.content.style.paddingBottom = ui.footer.style.height;
								});
								ui.boxMsgText.addEventListener('tap', function(event) {
									ui.boxMsgText.focus();
									setTimeout(function() {
										ui.boxMsgText.focus();
									}, 0);
								}, false);
			
								//-------------------------------------------------------------------------------
								var webSocket = new WebSocket(webSocketServerUrl+'?userName='+loginName+'&type=2&chatRoomId='+chatRoomId);
								webSocket.onerror = function(event) {
							      onError(event);
							    };
								 
							    webSocket.onopen = function(event) {
							      onOpen(event);
							    };
							 
							    webSocket.onmessage = function(event) {
							      onMessage(event);
							    };
							 
							    function onMessage(event) {
							    	var content_ = event.data;
							    	var cs_ = content_.split("{【】}");
							    	content_ = cs_[0];
							    	var sender_ = "";
							    	var type_ = cs_[1];
							    	if(content_.indexOf(loginName) != -1){
							    		content_ = content_.replace(loginName+"：","");
							    		sender_ = "self";
							    	}else
							    		sender_ = "onther";
							    	/*
							    	 * type!=text；需要下载文件
							    	 */
							    	var msg = {
											sender: sender_,
											type: type_,
											content: content_
										};
									if(type_ != "text"){
										//先要判断文件是否存在与当前手机中
							    		judFile(msg,"send","no",[]);
							    	}else{
							        	record.push(msg);
										bindMsgList();
										difHeight();
									}
							    }
								 
							    function onOpen(event) {
							    }
							 
							    function onError(event) {
							    }
								//-------------------------------------------------------------------------------
								/*
								* 上传
								*/
								function uploadFile(msg){
									var filePath = msg.content;
									var wt=plus.nativeUI.showWaiting();
									var task = plus.uploader.createUpload(basePath+"FileUpload", 
									{method:"POST",blocksize:204800,priority:100},
									function ( t, status ) {
										// 上传完成
										if(status==200){//成功后再保存数据
											var res = t.responseText;
											res = res.replace('success','"success"');
											res = res.replace('realFileName','"realFileName"');
											res = res.replace("'",'"');
											res = res.replace("'",'"');
											res = JSON.parse(res);
											var fileName = res.realFileName;
											wt.close();
											//文件路径需要改为服务器存放路径
											webSocket.send('{"chatRoomId":"'+chatRoomId+'", "fromName":"'+loginName+'","sendType":"'+msg.type+'", "content":"'+fileName+'"}');
											//由于文件名被改变，所以上传完后，需要删除掉对应文件
											delFile(msg);
										}else{
											wt.close(); 
										}   
									});
									//获取当前时间作为key值，便面重复
									var keyvar = "file"+(new Date()).valueOf(); 
									task.addFile(filePath,{key:keyvar});
									task.start();
								}
								//压缩
								function compressImage(msg){
									if(msg.type == "image"){
								//		console.log(msg.content);
										var src_ = msg.content;
										var fileName = src_.substring(src_.lastIndexOf("/")+1,src_.length);
										var dst_ = "_doc/"+fileName;
										var q_ = 15;
										if('iOS'==plus.os.name)
											q_ = 10;
										var options = {
											src:src_,
											dst:dst_,
											overwrite:true,
											quality:q_
										};
										plus.zip.compressImage(
											options,
											function(event) {
												var target = event.target; // 压缩转换后的图片url路径，以"file://"开头
								//				console.log("压缩后图片路径>>>>>"+target);
								//				var size = event.size; // 压缩转换后图片的大小，单位为字节（Byte）
								//				var width = event.width; // 压缩转换后图片的实际宽度，单位为px
								//				var height = event.height; // 压缩转换后图片的实际高度，单位为px
								//				console.log("大小>>>"+size);
								//				console.log("长宽质量>>>"+(width*height*15));
								//				alert("Compress success!");
												msg.content = target;
												uploadFile(msg);
											},
											function(error) {
								//				alert("Compress error!");
											}
										);
									}else{
										uploadFile(msg);
									}
								}
							});
						}(mui, document));
		</script>
		<script>
		</script>
	</body>

</html>	