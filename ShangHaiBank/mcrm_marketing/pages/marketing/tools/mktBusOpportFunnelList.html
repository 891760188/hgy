<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>销售漏斗</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script type="text/javascript" src="../../common/AppBooter.js"></script>
		<script src="../../../../resource/mui/js/mui.picker.min.js"></script>
		<link rel="stylesheet" type="text/css" href="../../../../resource/mui/css/mui.picker.min.css" />
		<!--<script type="text/javascript" src="mainPage.js" ></script>-->
		<style>
			.chart {
				height: 270px;
				padding: 0px;
				margin-top: 0px;
				margin-left: 20px;
				margin-right: 20px;
			}
			font{
				 color:#007aff;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div id="fxchartId">
						<div class="chart" id="funnelChart"></div>
					</div>
					<div class="ys-custTitle" style="text-align: center;margin-top: -30px;">销售漏斗列表</div>
					<ul class="mui-table-view" id="ulId">
						<!--<li class="mui-table-view-cell toolHover">
							<a class="mui-navigate-right ys-list-cell">
								<span class="ys-lcLeft1" ><b>商机阶段：</b><font>了解商机</font></span>
								<span class="ys-lcLeft1"><b>销售阶段：</b>了解客户需求</span>
								<span class="ys-lcLeft"><b>达成概率：</b>10%</span>
								<span class="ys-lcRight"><b>商机数量：</b>6</span>
								<span class="ys-lcLeft"><b>预计金额：</b>0.00</span>
								<span class="ys-lcRight"><b>权重金额：</b>0.00</span>
							</a>
						</li>-->
					</ul>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../../../../resource/echarts3/echarts.min.js"></script>
		<script type="text/javascript">
			//App配置信息
			var appConfig = {
				swipeBack: false
			};
			_App.init(appConfig);
			mui('.mui-scroll-wrapper').scroll();
			var ulId=document.getElementById('ulId');
			var condition={};  
			var datas=[];
			//筛选数据
			function reset(){
				muiCard1.reset();
			}
			mui.plusReady(function(){
				ajaxRequest();
			});
			
			function ajaxRequest(){
				_App.ajax({
			    	type : "get",
			  		url :basePath + 'mktBusiOpporFunnelQueryAction.json',
					data:{
						condition:JSON.stringify(condition)
					},
			 		cache: false,
			   		dataType: "json", 
			   		success : function(response){
			   			var data = response.json.data;
			   			for(var i=0;i<data.length;i++){
			   				var li=document.createElement('li');
			   				li.className = 'mui-table-view-cell toolHover';
			   				if(data[i].COUNT_AMOUNT==""){
			   					data[i].COUNT_AMOUNT='0.00';
			   				}
			   				if(data[i].COUNT_WEIGHT==""){
			   					data[i].COUNT_WEIGHT='0.00';
			   				}
			   				var tData=[];
			   				tData[0]=data[i].F_C_V;
			   				tData[1]=data[i].COUNT_NUMBER;
			   				datas.push(tData);
			   				li.innerHTML = '<a id="'+data[i].F_CODE+'" class="mui-navigate-right ys-list-cell">'
										+'<span class="ys-lcLeft1" ><b>商机阶段：</b><font>'+data[i].F_C_V+'</font></span>'
										+'<span class="ys-lcLeft1"><b>销售阶段：</b>'+data[i].COUNT_STAGE+'</span>'
										+'<span class="ys-lcLeft"><b>达成概率：</b>'+data[i].COUNT_PERCENT+'</span>'
										+'<span class="ys-lcRight"><b>商机数量：</b>'+data[i].COUNT_NUMBER+'</span>'
										+'<span class="ys-lcLeft"><b>预计金额：</b>'+data[i].COUNT_AMOUNT+'</span>'
										+'<span class="ys-lcRight"><b>权重金额：</b>'+data[i].COUNT_WEIGHT+'</span>'
										+ '</a>';
							ulId.appendChild(li);
			   			}
			   			pieChart.setOption(getOption('funnel'));
					},
			 		error:function(a,b,c){
			 			mui.alert("网络连接出错!"); 
			 		}
			 	});
			}
			mui('#ulId').on('tap','a',function(){
				var id=this.getAttribute('id');
				_App.util.goPage('mktBusOpportDetails.html?id='+id,'none');
			});
			var getOption = function(chartType) {
				var chartOption = {
					title : {
							text: '商机漏斗',
							x:'center',
							padding:[10,0,0,0],
							textStyle:{
								color:'#666',
								fontWeight:'normal',
								fontSize:14
							}
						},
					tooltip: {
						trigger: 'item',
						formatter: "{a} <br/>{b} : {c}"
//						formatter:function (params) { 
//                                 var res = params.value*100/params.series.max+"%";
//									res=params[0]+"<br/>"+params[1]+":"+res;
//                               	return res;
//                           	}

					},
					calculable: true,
					color: _chartsColors,
					series: [{
						 name: '商机斗图',
						type: 'funnel',
						left: '10%',
						bottom:40,
						top:50,
						width: '80%',
						// height: {totalHeight} - y - y2,
						min: 0,
						max: 10,
						minSize: '0%',
						maxSize: '100%',
						funnelAlign: 'center',
						sort: 'descending', // 'ascending', 'descending'
						gap: 4,
						data: [{
							value: datas[0][1],
							name: datas[0][0]
						}, {
							value: datas[1][1],
							name: datas[1][0]
						}, {
							value: datas[2][1],
							name: datas[2][0]
						}, {
							value: datas[3][1],
							name: datas[3][0]
						}, {
							value: datas[4][1],
							name: datas[4][0]
						}]
					}]
				};
				return chartOption;
			};
			var byId = function(id) {
				return document.getElementById(id);
			};
			var pieChart = echarts.init(byId('funnelChart'));
			window.addEventListener("GO2SHARE",function(){
				var chart=document.getElementById('fxchartId').querySelector('canvas'); 
				var imgUrl = chart.toDataURL('image/png');
				bitmap = new plus.nativeObj.Bitmap();
				bitmap.loadBase64Data(imgUrl);
				saveBitmap(); 
				
			});
			function saveBitmap() {
				var cwebviewId=plus.webview.currentWebview().id;
				var timestamp=new Date().getTime();
				var imgName="attachment"+timestamp+".png";
					bitmap.save("_doc/"+imgName, {
					overwrite: true
				}, function(i) {
					console.log('保存图片成功：' + JSON.stringify(i));
					imgUrl ="file://" + i.target;
					plus.storage.removeItem("_shareImgPath_")
					plus.storage.setItem("_shareImgPath_","_doc/"+imgName);
					var url = "../../finding/share/share.html?cwebviewObjId="+cwebviewId+"&bizType=OPP&bizId=9999";
						_App.util.goPage(url, {
						pageId: 'share_id',
						refresh: true
					});
				}, function(e) {
					console.log('保存图片失败：' + JSON.stringify(e));
				});
			}
		</script>
	</body>

</html>