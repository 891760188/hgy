<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=PwtEGYwzpanIhIoeNQj9N4Xb"></script>
		<script src="../../common/AppBooter.js"></script>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=PwtEGYwzpanIhIoeNQj9N4Xb"></script>
		<script src="signMap.js"></script>
		<title>地图展示</title>
		<style type="text/css">
			html,
			body {
				width: 100%;
				height: 100%;
			}
			#allmap {
				width: 100%;
				height: 100%;
				overflow: hidden;
			}
			.locationPanel {
				background-color: #fff;
				margin: 10px;
				padding: 10px;
				border-radius: 8px;
			}
			.locInfo {
				padding-bottom: 10px;
				border-bottom: 1px #ddd solid;
				position: relative;
			}
			.locInfo>b,.locInfo>span{
				clear: left;
				display: block;
				line-height: 20px;
				padding: 3px 0;
				font-size: 16px;
			}
			.locInfo>span{
				font-size: 12px;
				color: #666;
			}
			.btView{
				position: absolute;
				right: 0;
				display: block;
				padding: 5px 8px;
				border: 1px #ddd solid;
				border-radius: 3px;
				top:15px;
				color: #333;
			}
			.btView:active{
				color: #ea5404;
				border: 1px #ea5404 solid;
			}
			.liBts{
				padding-top: 10px;
				text-align: center;
			}
			.liBts>button{width: 65px;}
			.liBts>button:active{
				color: #ea5404!important;
				border: 1px #ea5404 solid;
				background-color: #fff!important;
			}
			.anchorBL{display:none}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<a id="locations" class="mui-icon mui-icon-location mui-pull-right"></a>
			<h1 id="title" class="mui-title">外勤足迹</h1>
		</header>
		<div id="allmap"></div>
		<div id="sheet" class="mui-popover mui-popover-bottom mui-popover-action ">
			<div class="locationPanel">
				<div id="div" class="locInfo">
					<b>北京XX科技有限公司</b>
					<span>15.2公里&nbsp;&nbsp;&nbsp;&nbsp;朝阳区南十里居路</span>
					<a class="btView">详情</a>
				</div>
				<div class="liBts" id="liBtsDivId">
					<button class="bs">打电话</button>
					<button class="bs">到这去</button>
					<button class="bs">录商机</button>
					<button class="bs">发消息</button>
				</div>
			</div>
		</div>
	</body>

</html>
<script type="text/javascript">
	mui.init();
	//	mui.plusReady(function(){
	var webview_style0 = {
		popGesture: "close"
	};
	var map = new BMap.Map("allmap");
	var geolocation = new BMap.Geolocation();
	var geoc = new BMap.Geocoder();
	var arrPolyline = [];
	var point;//客户坐标
	var points;//定位我的坐标
	var startLon;
	var startLat;
	var endLon;
	var endLat;
	function deal(datas,lon,lat,mapState) {
		startLon = lon;
		startLat = lat;
		data = datas;
		//0表示是范围查询，1表示其它查询
		if(mapState==0){
			map.clearOverlays();
			arrPolyline = [];
		}
		var div = document.getElementById('div');
		points = new BMap.Point(data[0].SIGN_LONGITUDE ,data[0].SIGN_LATITUDE);
		map.centerAndZoom(points, 14);
//		var myIcon = new BMap.Icon("../../../images/pic_11_1.png", new BMap.Size(32, 58));  
//		var mk = new BMap.Marker(points,{icon:myIcon});
//		map.addOverlay(mk);
		map.panTo(points);
//		mk.addEventListener("click", function(e) {
//			var s;
//			geoc.getLocation(points, function(rs){
//				var addComp = rs.addressComponents;
//				s= addComp.city+addComp.district+ addComp.street;
//				div.innerHTML = '<b>我的位置:</b><span>'+ s+ '</span>';
//				mui('#sheet').popover('toggle'); 
//			}); 
//		});
		for (var i = 0; i < data.length; i++) {
				point = new BMap.Point(data[i].SIGN_LONGITUDE, data[i].SIGN_LATITUDE);
				arrPolyline.push(point);
				setPolyline();
				var marker = new BMap.Marker(point);
				map.addOverlay(marker);
				marker.addEventListener("click", function(e) {
					endLon = this.z.point.lng;
					endLat = this.z.point.lat;
					var newpoint = new BMap.Point(this.z.point.lng, this.z.point.lat);
					geoc.getLocation(newpoint, function(rs) {
						for (var j = 0; j < data.length; j++) {
							if (rs.point.lng == data[j].LONGITUDE && rs.point.lat == data[j].LATITUDE) {
								var addComp = rs.addressComponents;
								var distance = data[j].DISTANCE;//将千米转换为米
								div.innerHTML = '<a class="ys-list-cell"><span class="ys-lcLeft"><b>'+data[j].CUST_NAME+'</b>('+data[j].STAT+')</span>'
												+'<span class="ys-lcRMin">'+distance+'公里</span>'
												+'<span><i class="mui-icon mui-icon-location"></i>地址：'+data[j].LOCATION+'</span>'
												+'<span><i class="mui-icon mui-icon-person"></i>主办客户经理：'+data[j].MGR_NAME+'</span>'
												+'<a class="btView">详情</span>'
												+'</a>';
		//						div.children[2].id = "3d";
							}
						}
					});
					mui('#sheet').popover('toggle'); //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏
				});
		}
	}
	
	mui(".locInfo").on('tap', '.btView', function() {
			var s = this.innerHTML;
			if (s == "详情") {
				var s = this.id.substring(0, 1);
				goPage_(s);
				mui('#sheet').popover('toggle');
			}
	});
	
	mui(".liBts").on('tap', '.bs', function() {
		var s = this.innerHTML;
			if (s == "打电话") {
				plus.device.dial('10086');
				mui('#sheet').popover('toggle');
			} else if (s == "到这去") {
				goToVisit();
				mui('#sheet').popover('toggle');
			} else if (s == "录商机") {
				mui.openWindow({
					url: '../../marketing/opport/addOpportunity.html',
					id: '../../marketing/opport/addOpportunity.html'
				});
				mui('#sheet').popover('toggle');
			}else if(s=="发消息"){
				_App.util.goPage('../../SocialCol/marketingCircle/marketingCircle.html', {pageId: 'marketingCircleIds', refresh: true});
			}
	});
	var top_left_navigation = new BMap.NavigationControl(); //左上角，添加默认缩放平移控件      
	map.addControl(top_left_navigation);
	var geolocationControl = new BMap.GeolocationControl();
	map.addControl(geolocationControl);
</script>