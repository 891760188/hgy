<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>外勤签到</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--公共js-->
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=PwtEGYwzpanIhIoeNQj9N4Xb"></script>
		<script src="../../common/AppBooter.js"></script>
		<script src="../draftBox/draftSql.js"></script>
		<style type="text/css">
			b {
				color: #18b30d;
			}
			.mui-bar-nav>.mui-pull-right{
				color: #666;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<a id="addedit" class=".mui-action-back mui-btn mui-btn-blue mui-btn-link mui-pull-right">签到</a>
			<h1 class="mui-title">外勤签到</h1>
		</header>
		<div class="mui-content dark-bg">
			<div class="mui-scroll-wrapper mui-nofootscroll">
				<div id="divs" class="mui-scroll">
					<ul class="mui-table-view mui-table-view-group">
						<li class="mui-table-view-cell">
							<a>
								<span class="mui-icon mui-icon-minus"></span>
								<b>时间:</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="div1"></span>
							</a>
						</li>
						<li class="mui-table-view-cell">
							<a class="mui-navigate-right" onclick="selects()">
								<span class="mui-icon mui-icon-location"></span>
								<b>地址:</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="div2"></span>
							</a>
						</li>
					</ul>
					<ul class="mui-table-view mui-table-view-group">
						<li class="mui-table-view-cell">
							<a class="mui-navigate-right" onclick="selectedCust();">
								<span class="mui-icon mui-icon-star"></span>
								<b>关联客户:</b>&nbsp;&nbsp;&nbsp;&nbsp;<span id="custName"></span>
							</a>
						</li>
						<li class="mui-table-view-cell">
							<a class="mui-navigate-right" onclick="selectedCusts();">
								<span class="mui-icon mui-icon-personadd"></span>
								<b>关联联系人:</b>&nbsp;&nbsp;&nbsp;&nbsp;<span id="custNames"></span>
							</a>
						</li>
						<li class="mui-table-view-cell">
							<a>
								<span class="mui-icon mui-icon-compose"></span>
								<b>签到详情:</b><br /><br />
								<span>
									<textarea type="text"  id="ts" class="mui-input-clear" style="height:10em;" placeholder="备注内容"></textarea>
								</span>
							</a>
						</li>

					</ul>
				</div>
			</div>
		</div>
	</body>
	<script>
		mui.init();
		var div1 = document.getElementById('div1');
		var addedit = document.getElementById('addedit');
		var div2 = document.getElementById('div2');
		var ws;
		var longitude = '';
		var latitude = '';
		var custId;
		var backPage;
		var urlId;
		var savaFlag = false; //是否提示保存到草稿箱

		//初始化相应信息：时间，地址
		mui.plusReady(function() {
			createDB();
			createSignTable();
			createDraftTable();
			backPage = plus.webview.getWebviewById("outCount.html");
			ws = plus.nativeUI.showWaiting();
			var t = new Date();
			div1.innerHTML = t.getFullYear() + "-" + (t.getMonth() + 1) + "-" + t.getDate() + " " + t.getHours() + ":" + t.getMinutes();
			urlId = plus.webview.currentWebview().id;
			plus.storage.setItem("fieldSignUrl", urlId);
			if(mui.os.ios) {
				plus.webview.currentWebview().setStyle({
					softinputMode: "adjustResize" // 弹出软键盘时自动改变webview的高度
				});
			}
			//获取当前地址
			plus.geolocation.getCurrentPosition(function(p) {
				ws.close();
				if(!p.addresses) {
					mui.alert('定位失败，请检查相关设备!', '提示', function() {
						plus.webview.currentWebview().close();
					});
				} else {
					div2.innerHTML = p.address.province + p.address.district + p.address.street;
					longitude = p.coords.longitude;
					latitude = p.coords.latitude;
				}

			}, function(e) {
				ws.close();
				mui.alert("Geolocation error: " + e.message);
				plus.webview.currentWebview().close();
			}
//			, {
//				provider: 'baidu'
//			}
			);
		});

		//定位：选取自身地址
		function selects() {
			var s = div2.innerHTML;
			_App.util.goPage("maps.html");
		};
		//监听获取地址
		window.addEventListener('getDetail', function(event) {
			div2.innerHTML = event.detail.name;

		});

		var custName = document.getElementById('custName');
		var custNames = document.getElementById('custNames');
		//获取关联客户
		function selectedCust() {
			_App.util.goPage("customers.html?pageViewId=" + urlId, {
				pageId: 'customers.html'
			});
		}
		//监听关联客户
		window.addEventListener('customer', function(event) {
			custId = event.detail.custId;
			custName.innerHTML = event.detail.custName;
		});
		//获取关联联系人
		function selectedCusts() {
			_App.util.goPage("linkMan.html?pageViewId=" + urlId,{
			pageId:'linkMan.html'
	});
		}
		//监听关联联系人
		window.addEventListener('fieldSignUrl_link', function(event) {
			var name = event.detail.name;
			custNames.innerHTML = name;
		});

		//签到按钮：核实信息，符合签到成功，不符合提示用户
		addedit.addEventListener('tap', function() {
			if(custName.innerHTML == "" || custNames.innerHTML == "") {
				mui.toast("信息填写不全，请核实填写!");
			} else {
				ws = plus.nativeUI.showWaiting("正在签到...");
				var dataAddress = div2.innerHTML;
				var dataCustName = custName.innerHTML;
				var dataCustNames = custNames.innerHTML;
				var dataMemo = document.getElementById("ts").value;
				_App.ajax({
					type: "get",
					url: basePath + 'signCountAction!addSignCount.json?dataAddress=' + dataAddress + '&dataCustName=' + dataCustName + '&dataCustNames=' + dataCustNames + '&dataMemo=' + dataMemo +
						'&longitude=' + longitude + '&latitude=' + latitude + '&custId=' + custId,
					cache: false,
					dataType: "json",
					success: function(response) {
						ws.close();
						if(backPage != null) {
							mui.fire(backPage, 'paramBackEvent__', {});
						}
						plus.webview.currentWebview().close();
					},
					error: function(a, b, c) {
						mui.alert("签到失败");
						ws.close();
					}
				});
			}
		});

		//调整当前页面显示状况，避免页面紊乱
		var divs = document.getElementById('divs');
		var height1 = document.body.scrollHeight;
		window.addEventListener("resize", function() {
			if(document.body.scrollHeight == height1) {
				divs.children[0].style.display = "block";
				divs.children[1].style.display = "block";
			}
		}, false);

		//返回提示是否保存
//		var oldback = mui.back;
//		mui.back = function() { //getParaDatas
//				if(!savaFlag && (div2.innerHTML != '' && div2.innerHTML != 'undefined')) {
//					var btn = ["是", "否"];
//					mui.confirm('是否保存到草稿箱？', '温馨提示', btn, function(e) {
//						if(e.index == 0) { //保存到草稿箱
//							saveDraft();
//							oldback();
//						} else if(e.index == 1) {
//							oldback();
//						}
//					});
//				} else {
//					oldback();
//				}
//			}
			/**
			 * 保存到草稿箱
			 */
		function saveDraft() {
			var myDate = new Date();
			var year = myDate.getFullYear();
			var month = myDate.getMonth();
			var day = myDate.getDate();
			var hh = myDate.getHours();
			var mm = myDate.getMinutes();
			month = 1 + month;
			if(month < 10) {
				month = "0" + month;
			}
			var sysTime = year + '-' + month + '-' + day + ' ' + hh + ':' + mm;
			var userID = plus.storage.getItem('userName');
			var addren = document.getElementById('div2').innerHTML; //地址
			var custName = document.getElementById('custName').innerHTML; //关联客户
			var custNames = document.getElementById('custNames').innerHTML; //关联联系人
			var ts = document.getElementById('ts');
			var plist_ = [addren, custName, custNames, longitude, latitude, ts.value, custId];
			saveSign(plist_, ['1', sysTime, userID, '外勤签到', addren]);
		}
	</script>

</html>