<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<script type="text/javascript" src="../common/AppBooter.js"></script>
		<script src="echarts.js"></script>
		<script src="datas.js"></script>
		<style>
			#popver {
				height: 180px;
			}
			
			.toolsBar {
				position: relative;
				height: 70px;
				background-color: #f2f2f2;
				padding: 15px;
				border-bottom: 1px solid #e8e8e8;
			}
			
			.toolsBar .tbLeft {
				float: left;
				white-space: nowrap;
			}
			
			.toolsBar .tbRight {
				float: right;
			}
			
			.myPopver {
				position: absolute;
				top: 0px;
				width: 100%;
				height: 170px;
				border-radius: 0;
			}
			
			.leftButon {
				height: 40px;
				width: 50%;
				float: left;
				text-align: center;
				line-height: 40px;
				border-right: 1px solid #cacaca;
			}
			
			.rightButton {
				height: 40px;
				width: 50%;
				float: right;
				text-align: center;
				line-height: 40px;
			}
		</style>
	</head>
	
	<body>
		<div id="main1" style="width:100%;"></div>
		<div id="myPopver" class="mui-popover myPopver">
			<div class="ys-custInfo" id="company">
				<p style="text-align: center; font-size: 16px;" id="custName">北京天琪科技集团股份有限公司</p>
				<p><b>注册资本：</b><span>550000000.00</span></p>
				<p><b>联系人：</b><span>吴亮</span></p>
				<p><b>联系电话：</b><span>13909089876</span></p>
			</div>
			<div class="ys-custInfo" id="customer">
				<p><b>客户等级：</b><span>白金客户</span></p>
				<p><b>职业：</b><span>IT行业技术人员</span></p>
				<p><b>联系地址：</b><span>四川成都</span></p>
				<p><b>联系电话：</b><span>13909089876</span></p>
			</div>
			<div>
				<div class="leftButon" id="goAtlas" data-type="-1">
					<a>图谱</a>
				</div>
				<div class="rightButton" id="goInfo" data-type="-1">
					<a >详情</a>
				</div>
			</div>
		</div>
	</body>
	<script>
		var nowFontSize = 8;
		Array.prototype.contains = function(needle) {
			for(i in this) {
				if(this[i] == needle) return true;
			}
			return false;
		}
		mui.ready(function(){
			var _height=document.body.scrollHeight;
			document.getElementById('main1').style.height=_height-44+"px";
			chart1();
			
			//详情
			document.getElementById('goInfo').addEventListener('tap',function(){
				var cn = document.getElementById('custName').innerText;
				var type = document.getElementById('goInfo').getAttribute('data-type');
				var url = 'priCustomerDetail.html?custName='+encodeURIComponent(cn);
				if(type==1){
					//公司信息
					url = 'comCustomerDetail.html?custName='+encodeURIComponent(cn);
				}
				
				_App.util.goPage(url);
			});
			//
			//图谱
			document.getElementById('goAtlas').addEventListener('tap',function(){
				plus.nativeUI.showWaiting('加载中...');
				setTimeout(function(){
					mui("#myPopver").popover('hide');
					plus.nativeUI.closeWaiting();
					plus.webview.currentWebview().reload();
				},1500);
			});
		})
		function chart1() {
		
			var myChart = echarts.init(document.getElementById('main1'));
		
			myChart.showLoading();
			myChart.hideLoading();
		
			option = {
				tooltip: {
			        trigger: 'item',
			        formatter: function(params){
			        	return params.data.id;
			        	
			        }
			   },
				legend: {
					data: personCategory.map(function(a) {
							return a.name;
						}) //此处的数据必须和关系网类别中name相对应
				},
				animationDurationUpdate: 1500,
				animationEasingUpdate: 'quinticInOut',
				series: [{
					type: 'graph',
					layout: 'circular',
					circle: "more",
					circular: {
						rotateLabel: true
					},
					animation: true,
					label: {
						normal: {
							show: true,
							position: 'top',
							textStyle: {
								fontSize: nowFontSize
							}
						},
						emphasis:{
							show:true
							
						}
					},
					data: personData.map(function(node, idx) {
						node['value'] = '10';
						node['symbolSize'] = '11';
						node.id=idx;
						if(node.r==1||node.r==0){
							node['name']=''
						}
						if(idx == 0) {
							node['symbolSize'] = 20;
						}
						if(node.r == 1) {
							node['symbolSize'] = 15;
						}
						return node;
					}),
					categories: personCategory,
					roam: true,
					lineStyle: {
						normal: {
							color: 'source',
							curveness: -0.1
						}
					},
					force: {
						edgeLength: 95, //连线的长度
						repulsion: 40 //子节点之间的间距
					},
					links:personLink.map(function(data){
						if(data.relation){
							data['label']={
								normal:{
									show:true,
									textStyle: {
										fontSize: nowFontSize
									},
									formatter:data.relation
								}
							}
							
						}
						return data;
					})
				}]
			};
			myChart.setOption(option);
			myChart.on('click',function(data){
				var d = data.data;
				if(d.r>1){
					if(d.type==1){
						document.getElementById('company').style.display="block";
						document.getElementById('custName').innerHTML=d.name;
						document.getElementById('customer').style.display="none";
					}else{
						document.getElementById('company').style.display="none";
						document.getElementById('customer').style.display="block";
					}
					document.getElementById('goInfo').setAttribute('data-type',d.type);
					document.getElementById('goAtlas').setAttribute('data-type',d.type);
					mui("#myPopver").popover('show');			
				}
			})
			
			//字体缩放
			var myTime=null;
			myChart.on('graphRoam',function(data){
				if(data.zoom){
					nowFontSize = data.zoom*nowFontSize;
					if(myTime)
						clearTimeout(myTime);
					myTime=setTimeout(function(){
						option.series[0].label.normal.textStyle.fontSize=nowFontSize;
						var tmpLink = personLink.map(function(data){
							if(data.relation){
								data.label.normal.textStyle.fontSize=nowFontSize;
							} 
							return data;
						});
						option.series[0].links=tmpLink;
						myChart.setOption(option);
					},150);
				}
				
			});
}
	</script>
</html>
