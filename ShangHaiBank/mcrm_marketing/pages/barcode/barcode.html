<!DOCTYPE HTML>
<html>

	<head>
		<meta charset="utf-8">
		<title>扫一扫</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script type="text/javascript" src="../common/AppBooter.js"></script>
		<script type="text/javascript" src="./barcode.js"></script>
		<script type="text/javascript" src="../scan/certificateScan.js"></script>
		<script type="text/javascript" src="../scan/visitingScan.js"></script>
		<script type="text/javascript">
			var img = null;
			var blist = [];
			function scaned( t, r, f ) {
				var d = new Date();
				var h=d.getHours(),m=d.getMinutes(),s=d.getSeconds(),ms=d.getMilliseconds();
				if ( h < 10 ) { h='0'+h; }
				if ( m < 10 ) { m='0'+m; }
				if ( s < 10 ) { s='0'+s; }
				if ( ms < 10 ) { ms='00'+ms; } else if ( ms < 100 ) { ms='0'+ms; }
				var ts = '['+h+':'+m+':'+s+'.'+ms+']';
				var li=null,hl = document.getElementById("history");
				if ( blist.length > 0 ) {
					li = document.createElement("li");
					li.className = "ditem";
					hl.insertBefore( li, hl.childNodes[0] );
				} else {
					li = document.getElementById("nohistory");
				}
				li.id = blist.length;
				var html = '['+h+':'+m+':'+s+'.'+ms+']'+'　'+t+'码<span>';
				html += r;
				html += '</span>';
				li.innerHTML = html;
				li.setAttribute( "onclick", "selected(id);" );
				blist[blist.length] = {type:t,result:r,file:f};
				update( t, r, f );
			}
			function selected( id ) {
				var h = blist[id];
				update( h.type, h.result, h.file );
				if ( h.result.indexOf("http://")==0  || h.result.indexOf("https://")==0 ) {
					plus.nativeUI.confirm( h.result, function ( i ) {
						if ( i.index == 0 ) {
							plus.runtime.openURL( h.result );
						}
					}, "", ["打开","取消"] );
				} else {
					plus.nativeUI.alert( h.result );
				}
			}
			function update( t, r, f ) {
				outSet( "扫描成功：");
				outLine( t );
				outLine( r );
				outLine( "\n图片地址："+f );
				if ( !f || f=="null" ) {
					img.src = "../img/barcode.png";	
				} else {
					plus.io.resolveLocalFileSystemURL(f,function(entry){
						img.src=entry.toLocalURL();
					});
					//img.src = "http://localhost:13131/"+f;
				}
			}
			function onempty() {
				if ( window.plus ) {
					plus.nativeUI.alert('无扫描记录');
				} else {
					alert( '无扫描记录' );
				}
			}
			function cleanHistroy() {
				if ( blist.length > 0 ) {
					var hl = document.getElementById("history");
					hl.innerHTML = '<li id="nohistory" class="ditem" onclick="onempty();">无历史记录	</li>';
				}
				plus.io.resolveLocalFileSystemURL( "_doc/barcode/", function ( entry ) {
					entry.removeRecursively( function () {
						// Success
					}, function ( e ) {
						//alert( "failed"+e.message );
					});
				} );
			}
		</script>
		<style type="text/css">
		p{margin: 10px;line-height: 25px;}
		#history{display: block; margin: 10px;}
		#history>li{display: block;padding: 10px;margin-top: 10px; table-layout:fixed; word-break: break-all; overflow:hidden;color: #777; line-height: 20px;background-color: #eee;border-radius: 5px;}
		#history>li#nohistory{text-align: center;color: #999;}
		#history>li>span{display: block; clear: left;color: #444;}
		#sharecontent{height: 150px;margin: 20px;margin: 0;}
		p>button.mui-btn{width: 100%;padding: 10px;color: #666;}
		p>button.mui-btn.danger{background: #4896cd;#ea5404;border: none;color: #fff;}
		p.img{text-align: center;}
		#bimg{width: 150px;}
		</style>
	</head>

	<body onload="img=document.getElementById('bimg');">

		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" onclick="back(true);"></a>
			<h1 class="mui-title">扫一扫</h1>
		</header>		
		<div class="mui-content">
			<div class="mui-scroll-wrapper mui-nofootscroll">
				<div class="mui-scroll">
					<p class="img"><img id="bimg" src="../system/appBarCode.png" /></p>
					<p><button type="button" class="mui-btn danger" onclick="clicked('barcode-scan.html',true,true);">扫一扫</button></p>
					<p><button type="button" class="mui-btn danger" onclick="shareCameraPicture1(0);">身份证扫描</button></p>
					<p><button type="button" class="mui-btn danger" onclick="shareCameraPicture(0);">名片扫描</button></p>
					<p style="text-align: center;">友情提示：为保证识别精度，请横屏拍摄</p>
					<ul id="history">
						<li id="nohistory" onclick="onempty();">无历史记录 </li>
					</ul>
					<p><button type="button" class="mui-btn" onclick="cleanHistroy();">清空历史记录</button></p>
					
				</div>
			</div>
		</div>
		<script type="text/javascript">			
		mui('.mui-scroll-wrapper').scroll();
		</script>
	</body>
</html>